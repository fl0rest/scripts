#!/bin/bash
#By DougieT, ty MikeJ <3
#domains=$(nxcli $1 --sites | tail -n +12 | cut -d'│' -f 4 | egrep -v 'nxcli|Name|Cname|─' | tr " " "\n" | sed '/^$/d')
domains=$(tail -n +12 ../sites | cut -d'│' -f 4 | egrep -v 'nxcli|Name|Cname|─' | tr " " "\n" | sed '/^$/d')
recs=""
function search() {
if [[ -z $recs ]]; then
    for i in $domains; do echo $i - $(dig a +short $i) | column -t; done
    else
    for i in $domains; do echo $i - $(dig $recs +short $i) | column -t; done
fi
exit 1
}

if [ $(wc -l <<<$domains) = 1 ]; then
    echo "Only one domain found! Printing DNS records..."
    echo -n "NS: "
    dig ns $domains +short | awk '{printf "%s ",$0 } END {print ""}'
    echo -n "A: "
    dig $domains +short | awk '{printf "%s ",$0} END {print ""}'
    echo -n "WWW: "
    dig www.$domains +short | awk '{printf "%s ",$0} END {print ""}'
    echo -n "rDNS: "
    dig -x $(dig $domains +short) +short | awk '{printf "%s ",$0} END {print ""}'
    echo -n "MX: "
    dig mx $domains +short ; dig $(dig mx $domains +short) +short | awk '{printf "%s ",$0} END {print ""}'
    echo "-----SPF and DKIM-----"
    dig txt $domains +short
    dig txt default._domainkey.$domains +short
    dig txt _dmarc.$domains +short
    exit 1
fi

help() {
    cat << endHelp
    accips  Get DNS records for all domains of an account (by default searches for A records)

    Usage: accips [NX ID] [-r|f|m|h]

    Options:

    r   rDNS query
    m   MX query
    f   Output domains to a file
    h   Show this
endHelp
}


while getopts "mrfh" args; do
    case $args in
        f)
            echo $domains | tr " " "\n" | tee account_domains.txt
            ;;
        m)
            recs=" mx"
            search
            ;;
        r)
            for i in $domains; do echo $i - $(dig -x $(dig $i +short) +short) | column -t; done
            exit 1
            ;;
        h)
            help
            ;;
        ?)
            echo "Usage: accips [m|r|f|h]"
            exit 1
            ;;
    esac
done
search